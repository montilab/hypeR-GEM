---
output: rmarkdown::github_document
always_allow_html: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r echo=FALSE, message=FALSE}
knitr::opts_chunk$set(message=FALSE, comment="#>")
devtools::load_all(".")
```

# hypeR.GEM

## (1) Installation

- Using `devtools` package

```r
library(devtools)
devtools::install_github("montilab/hypeR-GEM")
```

## Usage

```{r, eval=FALSE}
library(hypeR.GEM)
```


```{r}
## pathway = Animal Organ Regeneration
gene_query <- c("BAAT","HMOX1", "NNMT", "UGT1A1")

met_query <- c("(10Z)-heptadecenoic acid", "1-methylnicotinamide", "bilirubin", "biliverdin")

data("human_ig")

ig <- human_ig
df <- igraph::as_data_frame(ig, what = 'both')
metabolite_by = "symbol"
gene_by = "symbol"

## query nodes from "ig"，duplicated "symbol" implies multiple compartments
  query_df <- df$vertices %>%
    magrittr::set_rownames(., 1:nrow(.)) %>%
    tibble::rownames_to_column(var='vid') %>%
    dplyr::mutate(vid = as.numeric(vid)) %>%
    dplyr::filter(!is.na(!!as.name(metabolite_by)) & !is.na(!!as.name(gene_by))) %>%
    dplyr::filter(!!as.name(metabolite_by) %in% metabolite_query | !!as.name(gene_by) %in% gene_query) 

  ## obtain node Ids of gene_query，empty if gene_query = NULL
  gene_query_vids <- query_df %>%
    dplyr::filter(node_type == "gene") %>%
    dplyr::pull(vid)

  ## obtain node Ids of metabolite_query，empty if metabolite_query = NULL
  metabolite_query_vids <- query_df %>%
    dplyr::filter(node_type == "metabolite") %>%
    dplyr::pull(vid)

  ## gene_query and their neighbor, empty if gene_query = NULL
  gene_neighbor_vids <- lapply(igraph::neighborhood(ig, order=1, nodes= gene_query_vids, mode='all'), as.numeric) %>%
    unlist(.) %>%
    unique(.)

  ## metabolite_query and their neighbor，empty if metabolite_query = NULL
  metabolite_neighbor_vids <- lapply(igraph::neighborhood(ig, order=1, nodes= metabolite_query_vids, mode='all'), as.numeric) %>%
    unlist(.) %>%
    unique(.)

  ## specified visualization focus
  if(focus == "all"){
    all_vids <- unique(c(gene_neighbor_vids, metabolite_neighbor_vids))

  }
  if(focus == "metabolite"){
    all_vids <-  unique(c(metabolite_neighbor_vids, gene_query_vids))
  }
  if(focus == "pathway"){
    all_vids <- unique(c(gene_neighbor_vids, metabolite_query_vids))


  }



```



## Load signatures
```{r}
data(EL_signature)

str(EL_signature)

```


## Map metabolite signtures to associated genes

- `signatures` must be a named list
- `species = c("Human", "Mouse", "Rat", "Zebrafish", "Worm", "Other")` 
-  `merge`: merge metabolites from different department
- `promiscuous_threshold`: gene association threshold of promiscuous metabolite
- `ensemble_id`: for current version, if `species != 'Human`, use `ensemble_id = FALSE`
- `reference_key = 'refmet_name` by default
- `background` is used to compute gene-specific p-values, if `background = NULL`, then background = # of metabolites associated with non-exchange reactions


```{r}
hypeR_GEM_obj <- hypeR.GEM::signature2gene(signatures = EL_signature,
                                           species = "Human",
                                           merge = TRUE,
                                           promiscuous_threshold = 50,
                                           ensemble_id = TRUE,
                                           reference_key = 'refmet_name',
                                           background = NULL)


#unique(hypeR_GEM_obj$gene_tables$EL_down$signature_size)

hypeR_GEM_obj$mapped_metabolite_signatures$EL_down
```



```{r}
library(hypeR)
kegg <- msigdb_gsets(species="Homo sapiens", category="C2", subcategory = "CP:KEGG", clean = TRUE)
print(kegg)
```


## Hypergeometric test {.tabset}

### KEGG (unweighted) {.tabset}
```{r}
max_fdr <- 0.01
hypeR_GEM_enrichments_unweighted <- hypeR.GEM::enrichment(hypeR_GEM_obj,
                                         genesets = kegg$genesets,
                                         genesets_name = "KEGG",
                                         method='unweighted',
                                         metabolite_hits_filter_threshold = 2,
                                         background=3068)

hypeR_GEM_enrichments_unweighted$EL_up$data
```

#### Plot
```{r}
hypeR.GEM::enrichment_plot(hypeR_GEM_enrichments_unweighted,
                           top=50,
                           abrv=50,
                           size_by="significance",
                           fdr_cutoff= max_fdr,
                           val='fdr')+
  ggplot2::ggtitle(paste("FDR ≤", max_fdr)) +
  ggplot2::theme(axis.text.y = element_text(size = 7))
```

#### Reactable

Not quite sure why the reactable is not displayed normally in the .md file, but the function should work 
```{r}
#hypeR.GEM::rctbls(hypeR_GEM_enrichments_unweighted, fdr_cutoff=0.05)
```



### KEGG (weighted) {.tabset}
```{r}
max_fdr <- 0.01
hypeR_GEM_enrichments_weighted <- hypeR.GEM::enrichment(hypeR_GEM_obj,
                                         genesets = kegg$genesets,
                                         genesets_name = "KEGG",
                                         method='weighted',
                                         weights = 'one_minus_fdr',
                                         metabolite_hits_filter_threshold = 2,
                                         background=3068)
```

#### Plot
```{r}
hypeR.GEM::enrichment_plot(hypeR_GEM_enrichments_weighted,
                           top=40,
                           abrv=50,
                           size_by="significance",
                           fdr_cutoff= max_fdr,
                           val='fdr')+
  ggplot2::ggtitle(paste("FDR ≤", max_fdr)) +
  ggplot2::theme(axis.text.y = element_text(size = 7))
```

#### Reactable
```{r}
#hypeR.GEM::rctbls(hypeR_GEM_enrichments_weighted, fdr_cutoff=0.05)
```


```{r}
ig <- hypeR.GEM::human_ig

hypeR.GEM::Human_GEM_tables$meta_df_merged %>% 
  dplyr::filter(fullname %in% "lithocholic acid sulfate")

Human_GEM_tables$meta_df_merged$fullname[str_detect(Human_GEM_tables$meta_df_merged$fullname, "Lithocholic")]

p <- hypeR.GEM::visNet(ig, 
                  metabolite_query = c("bilirubin"),
                  by = "symbol")



p$p
```

