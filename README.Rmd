---
output: rmarkdown::github_document
always_allow_html: true
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r echo=FALSE, message=FALSE}
knitr::opts_chunk$set(message=FALSE, comment="#>")
devtools::load_all(".")
```

# hypeR.GEM

## (1) Installation

- Using `devtools` package

```r
library(devtools)
devtools::install_github("montilab/hypeR-GEM")
```

## Usage

```{r, eval=FALSE}
library(hypeR.GEM)
```


## Load signatures
```{r}
data(EL_signature)

str(EL_signature)

```


## Map metabolite signtures to associated genes

- `signatures` must be a named list
- `species = c("Human", "Mouse", "Rat", "Zebrafish", "Worm", "Other")` 
-  `merge`: merge metabolites from different department
- `promiscuous_threshold`: gene association threshold of promiscuous metabolite
- `ensemble_id`: for current version, if `species != 'Human`, use `ensemble_id = FALSE`
- `reference_key = 'refmet_name` by default
- `background` is used to compute gene-specific p-values, if `background = NULL`, then background = # of metabolites associated with non-exchange reactions


```{r}
hypeR_GEM_obj <- hypeR.GEM::signature2gene(signatures = EL_signature,
                                           species = "Human",
                                           merge = TRUE,
                                           promiscuous_threshold = 50,
                                           ensemble_id = TRUE,
                                           reference_key = 'refmet_name',
                                           background = NULL)


#unique(hypeR_GEM_obj$gene_tables$EL_down$signature_size)
```



```{r}
library(hypeR)
kegg <- msigdb_gsets(species="Homo sapiens", category="C2", subcategory = "CP:KEGG", clean = TRUE)
print(kegg)
```


## Hypergeometric test {.tabset}

### KEGG (unweighted) {.tabset}
```{r}
max_fdr <- 0.01
hypeR_GEM_enrichments_unweighted <- hypeR.GEM::enrichment(hypeR_GEM_obj,
                                         genesets = kegg$genesets,
                                         genesets_name = "KEGG",
                                         method='unweighted',
                                         metabolite_hits_filter_threshold = 2,
                                         background=3068)

hypeR_GEM_enrichments_unweighted$EL_up$data
```

#### Plot
```{r}
hypeR.GEM::enrichment_plot(hypeR_GEM_enrichments_unweighted,
                           top=50,
                           abrv=50,
                           size_by="significance",
                           fdr_cutoff= max_fdr,
                           val='fdr')+
  ggplot2::ggtitle(paste("FDR ≤", max_fdr)) +
  ggplot2::theme(axis.text.y = element_text(size = 7))
```

#### Reactable

Not quite sure why the reactable is not displayed normally in the .md file, but the function should work 
```{r}
#hypeR.GEM::rctbls(hypeR_GEM_enrichments_unweighted, fdr_cutoff=0.05)
```



### KEGG (weighted) {.tabset}
```{r}
max_fdr <- 0.01
hypeR_GEM_enrichments_weighted <- hypeR.GEM::enrichment(hypeR_GEM_obj,
                                         genesets = kegg$genesets,
                                         genesets_name = "KEGG",
                                         method='weighted',
                                         weights = 'one_minus_fdr',
                                         metabolite_hits_filter_threshold = 2,
                                         background=3068)
```

#### Plot
```{r}
hypeR.GEM::enrichment_plot(hypeR_GEM_enrichments_weighted,
                           top=40,
                           abrv=50,
                           size_by="significance",
                           fdr_cutoff= max_fdr,
                           val='fdr')+
  ggplot2::ggtitle(paste("FDR ≤", max_fdr)) +
  ggplot2::theme(axis.text.y = element_text(size = 7))
```

#### Reactable
```{r}
#hypeR.GEM::rctbls(hypeR_GEM_enrichments_weighted, fdr_cutoff=0.05)
```



