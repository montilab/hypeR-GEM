---
output: rmarkdown::github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(fig.path="./man/figures/", message=FALSE, collapse = TRUE, comment="")

# Load hypeR-GEM
library(devtools)
devtools::load_all(".")
```

# hypeR.GEM

![Gitter](https://img.shields.io/gitter/room/montilab/hypeR-GEM)
![GitHub issues](https://img.shields.io/github/issues/montilab/hypeR-GEM)
![GitHub last commit](https://img.shields.io/github/last-commit/montilab/hypeR-GEM)


# Installation

- Using `devtools` package

```r
library(devtools)
devtools::install_github("montilab/hypeR-GEM")
```

# Usage

Here, we are using a dataset of coronavirus disease 2019 (COVID-19) metabolite signatures obtained from human urine samples.

## (i) Load R packages

```{r, eval=FALSE}
library(hypeR.GEM)
```


## (ii) Load metabolite signatures

The dataset is a list object containing two data frames:

- up = up-regulated metabolites

- dn = down-regulated metabolites

```{r}
data(COVID_urine)
str(COVID_urine)
```

## (iii) hypeR-GEM mapping

- `signature`: A list of metabolic signatures. Each element must be a data frame containing a column whose name matches the `reference_key` argument, , which specifies the **RefMet** annotation for each metabolite.

- `directional`: Logical argument specifying the metabolite–reaction mapping rule.
  - If `TRUE`, metabolites are mapped only to reactions in which they appear as products (directional mapping).
  - If `FALSE`, metabolites are mapped to reactions in which they appear as either reactants or products (non-directional mapping).

- `promiscuous_threshold`: Maximum allowable number of metabolites associated with a gene. Genes exceeding this threshold are classified as promiscuous and excluded from downstream analysis.

- `background`: Background used in the gene-specific hypergeometric test. By default, this is set to the total number of metabolites represented in the GEM.

- `reference_key`: A character string indicating the column name in each signature data frame that contains **RefMet** metabolite identifiers.

```{r}
## Undirectional mapping
hypeR_GEM_obj <- hypeR.GEM::signature2gene(signatures = COVID_urine,
                                           directional = FALSE,
                                           promiscuous_threshold = 500,
                                           reference_key = 'refmet_name',
                                           background = NULL)


##Directional mapping
hypeR_GEM_obj_di <- hypeR.GEM::signature2gene(signatures = COVID_urine,
                                            directional = TRUE,
                                            promiscuous_threshold = 500,
                                            reference_key = 'refmet_name',
                                            background = NULL)
```

## (iv) Enrichment analysis in the gene space

Here we use REACTOME genesets as an example

```{r}
data(reactome)
```


### Unweighted (standard) Hypergeometric test

The background we use in this analysis equals to all protein(-coding) genes in the Human GEM model

```{r}
max_fdr <- 0.05

## Enrichment analysis from undirectional mapping
enrichment <- hypeR.GEM::enrichment(hypeR_GEM_obj,
                                    genesets = reactome,
                                    genesets_name = "REACTOME",
                                    method='unweighted',
                                    min_metabolite = 2,
                                    background=3068)


## Enrichment analysis from undirectional mapping
enrichment_di <- hypeR.GEM::enrichment(hypeR_GEM_obj_di,
                                       genesets = reactome,
                                       genesets_name = "REACTOME",
                                       method='unweighted',
                                       min_metabolite = 2,
                                       background=3068)
```

#### Visualization of enrichment analysis {.tabset}

##### Undirectional
```{r}
hypeR.GEM::enrichment_plot(enrichment,
                           top=40,
                           abrv=50,
                           size_by="significance",
                           fdr_cutoff= max_fdr,
                           val='fdr')+
  ggplot2::ggtitle(paste("FDR ≤", max_fdr)) +
  ggplot2::theme(axis.text.y = element_text(size = 7))

```

##### Directional
```{r}
hypeR.GEM::enrichment_plot(enrichment_di,
                           top=40,
                           abrv=50,
                           size_by="significance",
                           fdr_cutoff= max_fdr,
                           val='fdr')+
  ggplot2::ggtitle(paste("FDR ≤", max_fdr)) +
  ggplot2::theme(axis.text.y = element_text(size = 7))
```




### Weighted Hypergeometric test {.tabset}


```{r}
max_fdr <- 0.05

## Enrichment analysis from undirectional mapping
enrichment_wt <- hypeR.GEM::enrichment(hypeR_GEM_obj,
                                        genesets = reactome,
                                        genesets_name = "REACTOME",
                                        method='weighted',
                                        weighted_by = 'one_minus_fdr',
                                        min_metabolite = 2,
                                        background=3068)

## Enrichment analysis from Directional mapping
enrichment_wt_di <- hypeR.GEM::enrichment(hypeR_GEM_obj,
                                          genesets = reactome,
                                          genesets_name = "REACTOME",
                                          method='weighted',
                                          weighted_by = 'fdr',
                                          sigmoid_transformation = TRUE,
                                          min_metabolite = 2,
                                          background=3068)
```


#### Visualization of enrichment analysis {.tabset}

##### Undirectional
```{r}
hypeR.GEM::enrichment_plot(enrichment_wt,
                           top=40,
                           abrv=50,
                           size_by="significance",
                           fdr_cutoff= max_fdr,
                           val='fdr')+
  ggplot2::ggtitle(paste("FDR ≤", max_fdr)) +
  ggplot2::theme(axis.text.y = element_text(size = 7))
```

##### Directional
```{r}
hypeR.GEM::enrichment_plot(enrichment_wt_di,
                           top=40,
                           abrv=50,
                           size_by="significance",
                           fdr_cutoff= max_fdr,
                           val='fdr')+
  ggplot2::ggtitle(paste("FDR ≤", max_fdr)) +
  ggplot2::theme(axis.text.y = element_text(size = 7))
```

